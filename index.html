<html>

<head>
    <meta charset="utf-8">
    <title>Directed Graph Editor</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>

<body>
    <div style="position:absolute;left:0px;top:0px;width: 70%;height: 100vh;" id="graphSVG" tabindex="0"></div>
    <div style="position:absolute;right:0px;top:0px;width: 30%;height: 100vh;background-color: lightgray;" id="param" tabindex="1">
        <form action="" id="dynamic-table">
            <input type="number" placeholder="enter size" name="size">
            <br></br>
            <button>Create table</button>
            <br></br>

        </form>
        <div id="table-wrapper">
        </div>
</body>

<script src="d3.v3.min.js"></script>
<script src="main.js"></script>
<script>
    let form = document.getElementById("dynamic-table");

    form.addEventListener('submit', (e) => {
        e.preventDefault()

        
        let size = e.target.elements.size.value;

        dynamicTable(size);
    })

    let table = document.createElement("table");

    let tableWrapper = document.getElementById("table-wrapper");
    tableWrapper.innerHTML = ''
    tableWrapper.appendChild(table);


    let dynamicTable = (_size) => {

        table.width = (_size*50)+'px';
        for (let i = 1; i <= _size; i++) {
            let tr = document.createElement("tr");
            table.appendChild(tr)

            for (let n = 0; n < _size; n++) {
                let td = document.createElement("td");
                tr.appendChild(td);
                let input = document.createElement("input");
                input.type = 'text';
                input.maxLength = 1;
                input.classList.add('inputMatrix');
                input.id = i + "-" + n;
                td.appendChild(input)
                $('#'+i + "-" + n).keypress(function(e){
                    console.log(i + "-" + n)
                    var n1 = n+1
                    if(n1 == _size){
                        var i1 = i+1
                        if(i1 != _size){
                            $('#'+i1 + "-0").focus();
                        }
                    }else{
                        $('#'+i + "-" + n1).focus();
                    }
                    if(e.which == 48 || e.which == 49 || e.which == 8)return;
                    else return false; 
                });
            }
        }
    }
</script>
<script>
    class Node {
       constructor(val) {
          this.value = val
          this.antecedent = []
       }
       getValue() {
          return this.value
       }
       setAntecedent(antecedent) {
          this.antecedent.push(antecedent)
       }
       getAntecedent() {
          return this.antecedent
       }
    }

    class Graph {
       constructor(matrix) {
          this.racine = null
          this.node = []
          var alphabet = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J', 'K', 'L', 'M', 'N', 'O', 'P', 'Q', 'R', 'S', 'T', 'U', 'V', 'W', 'X', 'Y', 'Z']
          var num_rows = graphMatrix1.length
          var num_cols = graphMatrix1.length
          for (var i = 0; i < num_rows; i++) {
             var alphabetLetter = alphabet[i]
             this.node.push(new Node(alphabetLetter))
          }
          var nbRow = 0
          for (var rowIndex = 0 ; rowIndex < matrix.length ; rowIndex++) {
             var row = matrix[rowIndex]
             console.log("row : ")
             console.log(row)
             var rowLetter = alphabet[nbRow]
             var nodeRow = this.findNode(rowLetter)
                //console.log("Row = "+rowLetter)
             var nbAntecedent = 0
             for (var antecedentIndex = 0 ; antecedentIndex < row.length ; antecedentIndex++) {
                var antecedent = matrix[rowIndex][antecedentIndex]
                var antecedentLetter = alphabet[nbAntecedent]
                var antecedentNodeRow = this.findNode(antecedentLetter)
                if (antecedent == 1) {
                   //console.log("> "+antecedentLetter)
                   nodeRow.setAntecedent(antecedentNodeRow)
                }
                nbAntecedent += 1
             }
             nbRow += 1
          }

       }

       findNode(value) {
          console.log(this.node)
          for (var currentNodeIndex = 0 ; currentNodeIndex < this.node.length ; currentNodeIndex++) {
             var currentNode = this.node[currentNodeIndex]
             console.log("Current node : ")
             console.log(currentNode)
             if (currentNode.getValue() == value) {
                return currentNode
             }
          }
       }

       showDegre(value) {
          var noeud = this.findNode(value)
          var degre = noeud.getAntecedent().length;
          return "Degre de " + value + " : " + degre
       }
       show() {
          var returnValue = "<div>"
          for (var noeudIndex = 0 ; noeudIndex < this.node.length ; noeudIndex++) {
             var noeud = this.node[noeudIndex]
             var nodeVal = noeud.getValue()
             var nodeAntecedents = noeud.getAntecedent()
             returnValue += nodeVal+"<br>"
             for (var antecedentsIndex = 0 ; antecedentsIndex < nodeAntecedents.length ; antecedentsIndex++) {
                var antecedents = nodeAntecedents[antecedentsIndex]
                returnValue += " ↳ " + antecedents.getValue()+"<br>"
             }
          }
          returnValue += "</div>"
          return returnValue
       }
       createSVGfromGraph(){
           var newNodes = []
           var newLinks = []
            for (var noeudIndex = 0 ; noeudIndex < this.node.length ; noeudIndex++) {
                var noeud = this.node[noeudIndex]
                var nodeVal = noeud.getValue()
                var nodeAntecedents = noeud.getAntecedent()
                var nodeJson = { id: nodeVal, reflexive: false }
                nodeJson.x = 0;
                nodeJson.y = 0;
                newNodes.push(nodeJson);
            }
            for (var noeudIndex = 0 ; noeudIndex < this.node.length ; noeudIndex++) {
                var noeud = this.node[noeudIndex]
                var nodeVal = noeud.getValue()
                var nodeAntecedents = noeud.getAntecedent()
                for (var antecedentsIndex = 0 ; antecedentsIndex < nodeAntecedents.length ; antecedentsIndex++) {
                    var antecedents = nodeAntecedents[antecedentsIndex]
                    // Récupération de l'index du noeux enfant dans le graph
                    for (var currentNodeIndex = 0 ; currentNodeIndex < this.node.length ; currentNodeIndex++) {
                        var currentNode = this.node[currentNodeIndex]
                        if (currentNode.getValue() == antecedents.getValue()) {
                            var antecedentID = currentNodeIndex
                        }
                    }
                    newLinks.push({ source: newNodes[noeudIndex], target: newNodes[antecedentID], left: false, right: true });
                }
            }

            createSVG(newNodes, newLinks)
            
            //restart()
            //nodes.push({ id: "UIGBAU", reflexive: false });
            //links.push({ source: nodes[3], target: nodes[1], left: false, right: true });
       }

    }

    graphMatrix1 = [
       [0, 1, 0, 0, 0, 0],
       [0, 0, 1, 0, 0, 0],
       [0, 0, 0, 0, 1, 0],
       [0, 1, 0, 0, 0, 0],
       [0, 0, 0, 1, 0, 1],
       [0, 0, 0, 0, 0, 0]
    ]
    graph1 = new Graph(graphMatrix1)

    graph1.createSVGfromGraph()

 </script>


</html>